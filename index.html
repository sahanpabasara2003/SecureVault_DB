function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var email = e.parameter.email;
  var results = { passwords: [], notes: [], diary: [] };

  try {
    // දත්ත ලබාගන්නා පොදු function එක
    function getTabData(sheetName) {
      var sheet = ss.getSheetByName(sheetName);
      if (!sheet) return [];
      var data = sheet.getDataRange().getValues();
      var filtered = [];
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == email) {
          filtered.push({ row: i + 1, values: data[i] });
        }
      }
      return filtered;
    }

    results.passwords = getTabData("Passwords").map(item => ({
      id: item.row, platform: item.values[1], user: item.values[2], pass: item.values[3], url: item.values[4]
    }));

    results.notes = getTabData("Notes").map(item => ({
      id: item.row, title: item.values[1], content: item.values[2], time: item.values[3]
    }));

    results.diary = getTabData("Diary").map(item => ({
      id: item.row, date: item.values[1], mood: item.values[2], content: item.values[3]
    }));

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var data = JSON.parse(e.postData.contents);

  if (data.action === 'save_data') {
    var sheet = ss.getSheetByName(data.dataType === 'passwords' ? "Passwords" : (data.dataType === 'notes' ? "Notes" : "Diary"));
    var row = [data.email];
    Object.values(data.payload).forEach(val => row.push(val));
    sheet.appendRow(row);
    return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
  }
  
  // දත්ත මැකීම (Delete) සඳහා
  if (data.action === 'delete_data') {
    var sheet = ss.getSheetByName(data.tab);
    sheet.deleteRow(data.rowId);
    return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
  }
}
